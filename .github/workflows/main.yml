name: Build Dopamine Custom

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v4

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install Dependencies
      run: npm install --force

    # [新增步骤] 自动修改配置文件，去掉证书要求
    # 这一步会读取 electron-builder.config.js，把里面的 certificateSubjectName 改名，让打包工具读不到它
    - name: Patch Config File (Disable Signing)
      run: |
        node -e "const fs = require('fs'); const p = 'electron-builder.config.js'; try { let s = fs.readFileSync(p, 'utf8'); s = s.replace('certificateSubjectName', 'certificateSubjectName_DISABLED'); fs.writeFileSync(p, s); console.log('Config patched successfully!'); } catch(e) { console.error('Patch failed:', e); }"

    - name: Build Angular App
      run: npm run build:prod

    # [修改步骤] 这里的命令变短了，因为我们在上一步已经处理了证书问题
    - name: Package Electron App
      run: npx electron-builder build --windows --config electron-builder.config.js -c.win.verifyUpdateCodeSignature=false
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Dopamine-Custom-Build
        path: |
          dist/*.exe
          release/*.exe
