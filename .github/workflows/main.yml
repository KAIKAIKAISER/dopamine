name: Build Dopamine Custom

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Check out Git repository
      uses: actions/checkout@v4

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install Dependencies
      run: npm install --force

    # [核心修改] 暴力修改配置文件
    # 1. 搞坏证书名，让它找不到证书。
    # 2. 强行在 win: { ... } 里插入 verifyUpdateCodeSignature: false
    - name: Patch Config File (Disable Signing)
      run: |
        node -e "const fs = require('fs'); const p = 'electron-builder.config.js'; try { let s = fs.readFileSync(p, 'utf8'); s = s.replace('certificateSubjectName', 'certificateSubjectName_DISABLED'); s = s.replace('win: {', 'win: { verifyUpdateCodeSignature: false, '); fs.writeFileSync(p, s); console.log('Config patched successfully!'); } catch(e) { console.error('Patch failed:', e); process.exit(1); }"

    - name: Build Angular App
      run: npm run build:prod

    # [修改] 现在命令非常干净，没有 -c 参数了，不会再报错
    - name: Package Electron App
      run: npx electron-builder build --windows --config electron-builder.config.js
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Dopamine-Custom-Build
        path: |
          dist/*.exe
          release/*.exe
